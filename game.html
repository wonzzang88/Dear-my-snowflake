<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë„ˆì˜ ëˆˆì†¡ì´ë¥¼ ì°¾ì•„</title>
    <style>
        @font-face { font-family: 'Galmuri9'; src: url('fonts/Galmuri9.ttf') format('truetype'); }

        * {
            image-rendering: pixelated;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            box-sizing: border-box;
            font-family: 'Galmuri9', sans-serif;
        }

        body { margin: 0; padding: 0; background-color: #0b0e14; overflow: hidden; display: flex; height: 100vh; }

        /* ê²Œì„ í™”ë©´ ì˜ì—­ */
        #game-area {
            position: relative;
            width: 65vw;
            height: 100vh;
            background: url('images/background.png') no-repeat center center;
            background-size: cover;
            overflow: hidden;
        }

        /* ì˜¤ë¥¸ìª½ íŒ¨ë„ ì˜ì—­ */
        #side-panel {
            width: 35vw;
            height: 100vh;
            background-color: #121225;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            border-left: 2px solid #2c2c54;
            padding: 10px 2px;
        }

        /* UI í¬ê¸° ì¶•ì†Œ */
        #heart-container { 
            display: flex; flex-wrap: wrap; justify-content: center; 
            gap: 2px; width: 100%; margin-top: 5px;
        }
        .heart { font-size: 1rem; color: #ff4b2b; } /* í¬ê¸° ì¤„ì„ */
        .heart.lost { color: #333; }

        #timer { 
            color: #00fbff; font-size: 1.8rem; font-weight: bold; 
            margin: 5px 0; text-shadow: 0 0 5px rgba(0, 251, 255, 0.5); 
        }

        #target-box {
            width: 80px; height: 80px; /* ë°•ìŠ¤ í¬ê¸° ì¶•ì†Œ */
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid #00fbff;
            display: flex; align-items: center; justify-content: center;
            position: relative;
        }
        #target-box::before {
            content: 'TARGET'; position: absolute; top: -15px;
            color: #00fbff; font-size: 0.6rem;
        }

        #goal-count {
            margin-top: 5px; color: #ffeb3b;
            font-size: 0.8rem; font-weight: bold; /* í¬ê¸° ì¤„ì„ */
        }

        #target-snowflake-guide { width: 55px; height: 55px; background-size: contain; background-repeat: no-repeat; background-position: center; }

        /* ìºë¦­í„° í¬ê¸° ëŒ€í­ í™•ëŒ€ */
        #character-container {
            position: relative; 
            width: 110%; /* íŒ¨ë„ ë„ˆë¹„ë³´ë‹¤ ì‚´ì§ í¬ê²Œ í•˜ì—¬ ê½‰ ì°¨ê²Œ */
            aspect-ratio: 928 / 1120;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            margin-bottom: 10px;
        }

        canvas { display: block; touch-action: none; }
    </style>
</head>
<body>

    <div id="game-area">
        <canvas id="gameCanvas"></canvas>
    </div>

    <div id="side-panel">
        <div id="top-ui" style="text-align: center; width: 100%;">
            <div id="heart-container"></div>
            <div id="timer">50</div>
            <div id="target-box" style="margin: 0 auto;">
                <div id="target-snowflake-guide"></div>
            </div>
            <div id="goal-count">0 / 3</div>
        </div>

        <div id="character-container"></div>
    </div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const gameArea = document.getElementById('game-area');
    const timerDisplay = document.getElementById('timer');
    const guideElement = document.getElementById('target-snowflake-guide');
    const charContainer = document.getElementById('character-container');
    const heartContainer = document.getElementById('heart-container');
    const goalDisplay = document.getElementById('goal-count');

    const imgPaths = ['images/snowflake0.png', 'images/snowflake1.png', 'images/snowflake2.png', 'images/snowflake3.png'];
    const images = [];
    let snowflakes = [];
    let gameActive = false;
    let timeLeft = 50; // 50ì´ˆë¡œ ì—°ì¥
    let lives = 7;
    let successCount = 0;
    const requiredSuccess = 3; // 3ê°œ ì°¾ê¸°ë¡œ ë³€ê²½
    let targetIndex = Math.floor(Math.random() * 4);

    function initHearts() {
        heartContainer.innerHTML = '';
        for (let i = 0; i < 7; i++) {
            const heart = document.createElement('span');
            heart.className = 'heart';
            heart.innerText = 'â™¥';
            heartContainer.appendChild(heart);
        }
    }

    const selectedGender = localStorage.getItem('selectedGender') || 'girl';
    charContainer.style.backgroundImage = `url('images/${selectedGender}.png')`;

    function resize() {
        const dpr = window.devicePixelRatio || 1;
        const rect = gameArea.getBoundingClientRect();
        canvas.width = rect.width * dpr;
        canvas.height = rect.height * dpr;
        canvas.style.width = rect.width + 'px';
        canvas.style.height = rect.height + 'px';
        ctx.scale(dpr, dpr);
        ctx.imageSmoothingEnabled = false;
    }

    window.addEventListener('resize', resize);

    class Snowflake {
        constructor(isTarget) {
            this.isTarget = isTarget;
            this.size = 110;
            this.updateType();
            this.initPosition(true); // ì²˜ìŒ ìƒì„± ì‹œì—” ì „ì²´ í™”ë©´ ë²”ìœ„
        }

        updateType() {
            if (this.isTarget) {
                this.type = targetIndex;
            } else {
                let t;
                do { t = Math.floor(Math.random() * 4); } while (t === targetIndex);
                this.type = t;
            }
        }

        // ğŸŒŸ ëœ ê²¹ì¹˜ê²Œ í•˜ê¸° ìœ„í•œ ìœ„ì¹˜ ì„ ì • ë¡œì§
        initPosition(isFirstGen = false) {
            let collision = true;
            let attempts = 0;

            while (collision && attempts < 10) {
                this.x = Math.random() * (gameArea.clientWidth - this.size);
                // ì²« ìƒì„± ì‹œì—” í™”ë©´ ê³³ê³³ì— ë°°ì¹˜, ì´í›„ ë¦¬ì…‹ ì‹œì—” í™”ë©´ ë°”ë¡œ ìœ„ì—ì„œ ìƒì„±
                this.y = isFirstGen ? Math.random() * -gameArea.clientHeight : -this.size - (Math.random() * 200);
                
                collision = false;
                // ê¸°ì¡´ ë‹¤ë¥¸ ëˆˆì†¡ì´ë“¤ê³¼ ë„ˆë¬´ ê°€ê¹ì§€ ì•Šì€ì§€ ì²´í¬
                for (let s of snowflakes) {
                    if (s === this) continue;
                    let dist = Math.sqrt(Math.pow(this.x - s.x, 2) + Math.pow(this.y - s.y, 2));
                    if (dist < this.size * 0.8) { // í¬ê¸°ì˜ 80% ì´ë‚´ë©´ ê²¹ì¹œ ê²ƒìœ¼ë¡œ ê°„ì£¼
                        collision = true;
                        break;
                    }
                }
                attempts++;
            }
            this.speed = 0.4 + Math.random() * 0.4; // ë§¤ìš° ëŠë¦° ì†ë„
        }

        update() {
            this.y += this.speed;
            if (this.y > gameArea.clientHeight) {
                this.initPosition(false); 
            }
        }

        draw() {
            ctx.drawImage(images[this.type], Math.floor(this.x), Math.floor(this.y), this.size, this.size);
        }
    }

    let loadedCount = 0;
    imgPaths.forEach((src, i) => {
        const img = new Image();
        img.src = src;
        img.onload = () => {
            loadedCount++;
            images[i] = img;
            if (loadedCount === imgPaths.length) {
                resize();
                initGame();
            }
        };
    });

    function initGame() {
        initHearts();
        updateTarget();
        snowflakes = [];
        // ëˆˆì†¡ì´ê°€ í¬ë¯€ë¡œ ê²¹ì¹¨ ë°©ì§€ë¥¼ ìœ„í•´ ê°œìˆ˜ë¥¼ 12ê°œë¡œ ì‚´ì§ ìµœì í™”
        for(let i=0; i<12; i++) snowflakes.push(new Snowflake(false));
        snowflakes.push(new Snowflake(true));
        
        gameActive = true;
        updateLoop();
        startTimer();
    }

    function updateTarget() {
        targetIndex = Math.floor(Math.random() * 4);
        guideElement.style.backgroundImage = `url('${imgPaths[targetIndex]}')`;
        goalDisplay.innerText = `${successCount} / ${requiredSuccess}`;
        snowflakes.forEach(s => s.updateType());
    }

    function updateLoop() {
        if (!gameActive) return;
        ctx.clearRect(0, 0, gameArea.clientWidth, gameArea.clientHeight);
        snowflakes.forEach(s => { s.update(); s.draw(); });
        requestAnimationFrame(updateLoop);
    }

    function handleInput(e) {
        if (!gameActive) return;
        const rect = canvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        const mx = clientX - rect.left;
        const my = clientY - rect.top;

        for (let i = snowflakes.length - 1; i >= 0; i--) {
            const s = snowflakes[i];
            if (mx > s.x && mx < s.x + s.size && my > s.y && my < s.y + s.size) {
                if (s.isTarget) {
                    successCount++;
                    if (successCount >= requiredSuccess) {
                        gameActive = false;
                        window.location.href = 'success.html';
                    } else {
                        updateTarget();
                        s.initPosition(false);
                    }
                } else {
                    lives--;
                    updateHearts();
                    s.initPosition(false);
                    if (lives <= 0) gameOver("ê¸°íšŒë¥¼ ëª¨ë‘ ì†Œì§„í–ˆìŠµë‹ˆë‹¤!");
                }
                break;
            }
        }
    }

    canvas.addEventListener('mousedown', handleInput);
    canvas.addEventListener('touchstart', (e) => { e.preventDefault(); handleInput(e); }, {passive: false});

    function updateHearts() {
        const hearts = document.querySelectorAll('.heart');
        const targetIdx = 7 - (lives + 1);
        if (hearts[targetIdx]) hearts[targetIdx].classList.add('lost');
    }

    function gameOver(msg) {
        gameActive = false;
        alert(msg);
        location.href = 'index.html';
    }

    function startTimer() {
        const counter = setInterval(() => {
            if (!gameActive) { clearInterval(counter); return; }
            timeLeft--;
            timerDisplay.innerText = timeLeft;
            if (timeLeft <= 0) gameOver("ì‹œê°„ ì´ˆê³¼!");
        }, 1000);
    }
</script>
</body>
</html>
