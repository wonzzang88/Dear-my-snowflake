<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>도트 눈 결정 찾기 - 게임 플레이</title>
    <style>
        /* 1. 폰트 로드 (Galmuri9) */
        @font-face {
            font-family: 'Galmuri9';
            src: url('fonts/Galmuri9.ttf') format('truetype');
            font-weight: normal;
        }

        /* 2. 전체 요소에 갈무리 폰트 적용 */
        * {
            image-rendering: pixelated;
            user-select: none;
            box-sizing: border-box;
            font-family: 'Galmuri9', sans-serif;
        }

        body { 
            margin: 0; padding: 0; background-color: #0b0e14; 
            overflow: hidden; display: flex; height: 100vh; 
        }

        /* 왼쪽 게임 영역 (2/3) */
        #game-area {
            position: relative;
            width: 66.66vw;
            height: 100vh;
            background: url('images/background.png') no-repeat center center;
            background-size: cover;
            overflow: hidden;
        }

        /* 오른쪽 사이드 패널 (1/3) */
        #side-panel {
            width: 33.33vw;
            height: 100vh;
            background-color: #121225;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            border-left: 4px solid #2c2c54;
            padding: 30px 0;
        }

        /* 상단 타이머 및 가이드 영역 */
        #top-ui {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
        }

        #timer {
            color: #00fbff;
            font-size: 3.5rem;
            font-weight: bold;
            margin-bottom: 20px;
            text-shadow: 0 0 10px rgba(0, 251, 255, 0.5);
            /* 숫자에 갈무리 폰트가 잘 어울리도록 자간 조정 */
            letter-spacing: 2px;
        }

        /* 정답 눈송이 전용 네모 칸 */
        #target-box {
            width: 120px;
            height: 120px;
            background: rgba(255, 255, 255, 0.1);
            border: 4px solid #00fbff;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        #target-box::before {
            content: 'TARGET';
            position: absolute;
            top: -25px;
            color: #00fbff;
            font-size: 1rem;
            font-weight: bold;
        }

        #target-snowflake-guide {
            width: 80px;
            height: 80px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }

        /* 하단 캐릭터 컨테이너 */
        #character-container {
            position: relative;
            width: 80%;
            aspect-ratio: 928 / 1120;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            border: 4px solid rgba(255, 255, 255, 0.2);
            background-color: rgba(0,0,0,0.2);
        }

        canvas { display: block; }
    </style>
</head>
<body>

    <div id="game-area">
        <canvas id="gameCanvas"></canvas>
    </div>

    <div id="side-panel">
        <div id="top-ui">
            <div id="timer">30</div>
            <div id="target-box">
                <div id="target-snowflake-guide"></div>
            </div>
        </div>

        <div id="character-container"></div>
        
        <p style="color:#fff; font-weight:bold; margin: 0; font-size: 1.2rem;">똑같은 눈송이를 클릭!</p>
    </div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const gameArea = document.getElementById('game-area');
    const timerDisplay = document.getElementById('timer');
    const guideElement = document.getElementById('target-snowflake-guide');
    const charContainer = document.getElementById('character-container');

    const imgPaths = ['images/snowflake0.png', 'images/snowflake1.png', 'images/snowflake2.png', 'images/snowflake3.png'];
    const images = [];
    let loadedCount = 0;
    let snowflakes = [];
    let gameActive = false;
    let timeLeft = 30;
    
    let targetIndex = Math.floor(Math.random() * 4);

    const selectedGender = localStorage.getItem('selectedGender') || 'girl';
    charContainer.style.backgroundImage = `url('images/${selectedGender}.png')`;

    function resize() {
        const dpr = window.devicePixelRatio || 1;
        const rect = gameArea.getBoundingClientRect();
        canvas.width = rect.width * dpr;
        canvas.height = rect.height * dpr;
        canvas.style.width = rect.width + 'px';
        canvas.style.height = rect.height + 'px';
        ctx.scale(dpr, dpr);
        ctx.imageSmoothingEnabled = false;
    }

    window.addEventListener('resize', resize);

    class Snowflake {
        constructor(isTarget) {
            this.isTarget = isTarget;
            if (this.isTarget) {
                this.type = targetIndex;
            } else {
                let randomType;
                do { randomType = Math.floor(Math.random() * 4); } while (randomType === targetIndex);
                this.type = randomType;
            }
            this.size = 50; 
            this.reset();
        }
        reset() {
            this.x = Math.random() * (gameArea.clientWidth - this.size);
            this.y = -Math.random() * gameArea.clientHeight;
            this.speed = 1.8 + Math.random() * 2.2;
        }
        update() {
            this.y += this.speed;
            if (this.y > gameArea.clientHeight) this.reset();
        }
        draw() {
            ctx.imageSmoothingEnabled = false;
            ctx.drawImage(images[this.type], Math.floor(this.x), Math.floor(this.y), this.size, this.size);
        }
    }

    imgPaths.forEach((src, i) => {
        const img = new Image();
        img.src = src;
        img.onload = () => {
            loadedCount++;
            images[i] = img;
            if (loadedCount === imgPaths.length) {
                resize();
                initGame();
            }
        };
    });

    function initGame() {
        guideElement.style.backgroundImage = `url('${imgPaths[targetIndex]}')`;
        
        snowflakes = [];
        for(let i=0; i<30; i++) snowflakes.push(new Snowflake(false));
        snowflakes.push(new Snowflake(true));
        
        gameActive = true;
        updateLoop();
        startTimer();
    }

    function updateLoop() {
        if (!gameActive) return;
        ctx.clearRect(0, 0, gameArea.clientWidth, gameArea.clientHeight);
        ctx.imageSmoothingEnabled = false;
        snowflakes.forEach(s => {
            s.update();
            s.draw();
        });
        requestAnimationFrame(updateLoop);
    }

    canvas.addEventListener('mousedown', (e) => {
        if (!gameActive) return;
        const rect = canvas.getBoundingClientRect();
        const mx = e.clientX - rect.left;
        const my = e.clientY - rect.top;

        for (let i = snowflakes.length - 1; i >= 0; i--) {
            const s = snowflakes[i];
            if (mx > s.x && mx < s.x + s.size && my > s.y && my < s.y + s.size) {
                if (s.isTarget) {
                    gameActive = false;
                    window.location.href = 'success.html';
                }
                break;
            }
        }
    });

    function startTimer() {
        const counter = setInterval(() => {
            if (!gameActive) { clearInterval(counter); return; }
            timeLeft--;
            timerDisplay.innerText = timeLeft;
            if (timeLeft <= 0) {
                gameActive = false;
                alert("눈송이 찾기 실패!");
                location.href = 'index.html';
            }
        }, 1000);
    }
</script>
</body>
</html>